<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Tradutor Rápido – Ollama</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 2rem;
      }
      textarea {
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <h1 class="mb-4">Inglês → Português (pt-BR) (Ollama)</h1>

    <form method="post">
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="direction" class="form-label">Direção</label>
          <select id="direction" name="direction" class="form-select">
            <option value="en-pt" {% if direction=='en-pt' %}selected{% endif %}>English → Português (pt-BR)</option>
            <option value="pt-en" {% if direction=='pt-en' %}selected{% endif %}>Português (pt-BR) → English</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label for="text" id="text-label" class="form-label">Texto em Inglês</label>
        <textarea
          id="text"
          name="text"
          class="form-control"
          rows="6"
          placeholder="Digite ou cole o texto aqui…"
        >{{ request.form.get('text','') }}</textarea>
      </div>

      <button id="translateBtn" type="submit" class="btn btn-primary">
        <span id="translateSpinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display:none;"></span>
        <span id="translateLabel">Traduzir</span>
      </button>
    </form>

    {% if translated %}
    <hr />
    <h4>Tradução</h4>

    <div class="d-flex gap-2 mb-2">
      <button id="copyBtn" class="btn btn-outline-secondary">Copiar</button>
      <button id="saveBtn" class="btn btn-outline-primary">Salvar como .vtt</button>
    </div>

    <pre id="translated" class="bg-light p-3 rounded" style="white-space: pre-wrap">{{ translated }}</pre>

    {% endif %}

    <script>
      // Atualiza o label do textarea conforme a direção selecionada
      document.addEventListener('DOMContentLoaded', function(){
        const dir = document.getElementById('direction');
        const label = document.getElementById('text-label');
        function updateLabel(){
          if(dir.value === 'en-pt'){
            label.textContent = 'Texto em Inglês';
            label.nextElementSibling.placeholder = 'Digite ou cole o texto em inglês…';
          } else {
            label.textContent = 'Texto em Português (pt-BR)';
            label.nextElementSibling.placeholder = 'Digite ou cole o texto em português…';
          }
        }
        dir.addEventListener('change', updateLabel);
        updateLabel();

        // Previne múltiplos envios: ao submeter, desabilita o botão e mostra status
        const formEl = document.querySelector('form');
        const translateBtn = document.getElementById('translateBtn');
        const translateSpinner = document.getElementById('translateSpinner');
        const translateLabel = document.getElementById('translateLabel');

        if(formEl){
          formEl.addEventListener('submit', function(e){
            // se já estiver desabilitado, evita re-submissão
            if(translateBtn.disabled) return;
            translateBtn.disabled = true;
            translateSpinner.style.display = 'inline-block';
            translateLabel.textContent = 'Traduzindo...';
          });
        }

        // Botão copiar
        const copyBtn = document.getElementById('copyBtn');
        const saveBtn = document.getElementById('saveBtn');
        const translatedEl = document.getElementById('translated');
        if(copyBtn){
          copyBtn.addEventListener('click', async function(){
            try{
              await navigator.clipboard.writeText(translatedEl.textContent);
              copyBtn.textContent = 'Copiado!';
              setTimeout(()=> copyBtn.textContent = 'Copiar', 1500);
            }catch(e){
              alert('Não foi possível copiar: '+e);
            }
          });
        }

        if(saveBtn){
          saveBtn.addEventListener('click', function(){
            let text = translatedEl.textContent || '';
            text = text.trim();
            // se não começa com WEBVTT, adiciona cabeçalho simples
            if(!/^WEBVTT/i.test(text)){
              text = 'WEBVTT\n\n' + text;
            }
            const blob = new Blob([text], {type: 'text/vtt'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'translation.vtt';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          });
        }
      });
    </script>
  </body>
</html>
