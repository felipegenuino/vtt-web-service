<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Tradutor Rápido – Ollama</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 2rem;
      }
      textarea {
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <h1 class="mb-4">Inglês → Português (pt-BR) (Ollama)</h1>

    <form method="post">
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="source_lang" class="form-label">Source language</label>
          <select id="source_lang" name="source_lang" class="form-select">
            <optgroup label="Top languages">
              {% for code, name in languages_top %}
                <option value="{{ code }}" {% if source_lang==code %}selected{% endif %}>{{ name }} ({{ code }})</option>
              {% endfor %}
            </optgroup>
            <optgroup label="Other languages">
              {% for code, name in languages_other %}
                <option value="{{ code }}" {% if source_lang==code %}selected{% endif %}>{{ name }} ({{ code }})</option>
              {% endfor %}
            </optgroup>
          </select>
        </div>

        <div class="col-md-6">
          <label for="target_lang" class="form-label">Target language</label>
          <select id="target_lang" name="target_lang" class="form-select">
            <optgroup label="Top languages">
              {% for code, name in languages_top %}
                <option value="{{ code }}" {% if target_lang==code %}selected{% endif %}>{{ name }} ({{ code }})</option>
              {% endfor %}
            </optgroup>
            <optgroup label="Other languages">
              {% for code, name in languages_other %}
                <option value="{{ code }}" {% if target_lang==code %}selected{% endif %}>{{ name }} ({{ code }})</option>
              {% endfor %}
            </optgroup>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="text" id="text-label" class="form-label">Input text</label>
          <textarea
            id="text"
            name="text"
            class="form-control"
            rows="12"
            placeholder="Paste text or VTT content here…"
          >{{ request.form.get('text','') }}</textarea>
        </div>

        <div class="col-md-6 col mb-3">
          <label class="form-label">Translation preview</label>
          <div id="preview" class="border rounded bg-light p-3" style="min-height:220px;">
            {% if translated %}
              <div class="d-flex gap-2 mb-2">
                <button id="copyBtn" class="btn btn-sm btn-outline-secondary">Copy</button>
                <button id="saveBtn" class="btn btn-sm btn-outline-primary">Save as .vtt</button>
              </div>
              <pre id="translated" class="m-0" style="white-space: pre-wrap">{{ translated }}</pre>
            {% else %}
              <div id="emptyState" class="d-flex flex-column justify-content-center align-items-center text-muted" style="height:100%;">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-file-earmark-text mb-2" viewBox="0 0 16 16">
                  <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5z"/>
                </svg>
                <div><strong>No translation yet</strong></div>
                <div class="small">Paste VTT content or plain text and click Translate</div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="mt-2">
        <button id="translateBtn" type="submit" class="btn btn-primary">
          <span id="translateSpinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display:none;"></span>
          <span id="translateLabel">Translate</span>
        </button>
        <span id="detectedBadge" class="ms-3 text-muted small"></span>
      </div>
    </form>

    <script>
      // Atualiza o label do textarea conforme a direção selecionada
      document.addEventListener('DOMContentLoaded', function(){
        const dir = document.getElementById('direction');
        const label = document.getElementById('text-label');
        function updateLabel(){
          if(dir.value === 'en-pt'){
            label.textContent = 'Texto em Inglês';
            label.nextElementSibling.placeholder = 'Digite ou cole o texto em inglês…';
          } else {
            label.textContent = 'Texto em Português (pt-BR)';
            label.nextElementSibling.placeholder = 'Digite ou cole o texto em português…';
          }
        }
        dir.addEventListener('change', updateLabel);
        updateLabel();

        // Previne múltiplos envios: ao submeter, desabilita o botão e mostra status
        const formEl = document.querySelector('form');
        const translateBtn = document.getElementById('translateBtn');
        const translateSpinner = document.getElementById('translateSpinner');
        const translateLabel = document.getElementById('translateLabel');

        // Submissão controlada: detectar idioma antes de enviar
        if(formEl){
          formEl.addEventListener('submit', async function(e){
            e.preventDefault();
            if(translateBtn.disabled) return;
            translateBtn.disabled = true;
            translateSpinner.style.display = 'inline-block';
            translateLabel.textContent = 'Traduzindo...';

            const textVal = document.getElementById('text').value || '';
            // If empty, just submit normally
            if(!textVal.trim()){
              formEl.submit();
              return;
            }

            try{
              const resp = await fetch('/detect-language', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({text: textVal})
              });
              if(resp.ok){
                const j = await resp.json();
                const conf = j.confidence || 0.0;
                const display = j.display || j.code || 'unknown';
                detectedBadge.textContent = `Detectado: ${display} (${Math.round(conf*100)}%)`;
                // auto-apply if confidence >= 0.8
                if(conf >= 0.80 && j.code){
                  sourceSelect.value = j.code;
                }
              } else {
                // detection failed; show neutral message
                const j = await resp.json().catch(()=>null);
                if(j && j.error){
                  detectedBadge.textContent = `Detecção: ${j.error}`;
                }
              }
            }catch(err){
              // ignore detection error and proceed
              detectedBadge.textContent = 'Detecção indisponível';
            }

            // submit the form (will trigger server-side translation)
            formEl.submit();
          });
        }

        // Elements
        const copyBtn = document.getElementById('copyBtn');
        const saveBtn = document.getElementById('saveBtn');
        const translatedEl = document.getElementById('translated');
        const sourceSelect = document.getElementById('source_lang');
        const targetSelect = document.getElementById('target_lang');
        if(copyBtn){
          copyBtn.addEventListener('click', async function(){
            try{
              await navigator.clipboard.writeText(translatedEl.textContent);
              copyBtn.textContent = 'Copiado!';
              setTimeout(()=> copyBtn.textContent = 'Copiar', 1500);
            }catch(e){
              alert('Não foi possível copiar: '+e);
            }
          });
        }

        if(saveBtn){
          saveBtn.addEventListener('click', function(){
            let text = translatedEl.textContent || '';
            text = text.trim();
            // se não começa com WEBVTT, adiciona cabeçalho simples
            if(!/^WEBVTT/i.test(text)){
              text = 'WEBVTT\n\n' + text;
            }
            const blob = new Blob([text], {type: 'text/vtt'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Desktop equal-height + scrollable preview
            (function(){
              const style = document.createElement('style');
              style.textContent = `
                @media (min-width: 768px) {
                  .two-col { align-items: stretch; }
                  .two-col > .col { display:flex; flex-direction:column; }
                  #text { flex:1 1 auto; min-height:320px; }
                  #preview { flex:1 1 auto; overflow:auto; max-height:720px; }
                  #preview .d-flex { margin-bottom:0.5rem; }
                }
              `;
              document.head.appendChild(style);
            })();
            const tgt = (targetSelect && targetSelect.value) ? targetSelect.value : 'unknown';
            a.download = `translation_${tgt}.vtt`;
            document.body.appendChild(a);
            a.click();
            a.remove();
      });
    </script>
  </body>
</html>
